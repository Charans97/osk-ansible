# Kafka KRaft mode configuration
process.roles=broker,controller
node.id={{ node_id | default(loop.index) }}
controller.listener.names=CONTROLLER

# Listeners
listeners=PLAINTEXT://:9092,CONTROLLER://:9093{% if ssl.enabled | default(false) %},SSL://:9094{% endif %}

listener.security.protocol.map=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT{% if ssl.enabled | default(false) %},SSL:SSL{% endif %}

inter.broker.listener.name=PLAINTEXT

# Voters list (all brokers in quorum)
controller.quorum.voters={% for host in groups['brokers'] %}{{ loop.index }}@{{ hostvars[host].ansible_host }}:9093{% if not loop.last %},{% endif %}{% endfor %}

# Advertised listeners
advertised.listeners=PLAINTEXT://{{ ansible_host }}:9092{% if ssl.enabled | default(false) %},SSL://{{ ansible_host }}:9094{% endif %}

# Log dirs
log.dirs=/var/lib/kafka

# Performance tuning
num.network.threads=3
num.io.threads=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600

# SSL config (optional)
{% if ssl.enabled | default(false) %}
ssl.keystore.location={{ install_dir }}/config/kafka.keystore.jks
ssl.keystore.password={{ ssl.keystore_password | default('changeit') }}
ssl.key.password={{ ssl.key_password | default('changeit') }}
ssl.truststore.location={{ install_dir }}/config/kafka.truststore.jks
ssl.truststore.password={{ ssl.truststore_password | default('changeit') }}
{% endif %}

# SASL config (optional)
{% if sasl.enabled | default(false) %}
sasl.enabled.mechanisms=PLAIN
sasl.mechanism.inter.broker.protocol=PLAIN
listener.name.sasl_plaintext.plain.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required \
   username="{{ sasl.username | default('admin') }}" \
   password="{{ sasl.password | default('admin-secret') }}" \
   user_admin="{{ sasl.password | default('admin-secret') }}";
{% endif %}
